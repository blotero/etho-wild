name: Release Build

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release (e.g., v0.1.0)'
        required: false
        default: 'dev'

env:
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
  QT_VERSION: "6.7.2"

jobs:
  build-windows:
    runs-on: windows-latest
    name: Build (windows-x64)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Export GitHub Actions cache variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          cache: true

      - name: Install Ninja
        run: choco install ninja -y

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup vcpkg (OpenCV only)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "01f602195983451bc83e72f4214af2cbc495aa94"

      - name: Install OpenCV via vcpkg
        run: |
          ${{ github.workspace }}/vcpkg/vcpkg install opencv4:x64-windows

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -B build -S . `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${env:Qt6_DIR}" `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows

      - name: Build
        run: cmake --build build --config Release

      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item build/EthoWild.exe dist/
          Copy-Item behaviors.json dist/
          # Deploy Qt runtime DLLs
          & "$env:Qt6_DIR/../../../bin/windeployqt.exe" --release --no-translations dist/EthoWild.exe
          # Copy OpenCV DLLs
          Copy-Item "${{ github.workspace }}/vcpkg/installed/x64-windows/bin/*.dll" dist/ -ErrorAction SilentlyContinue

      - name: Create archive
        shell: pwsh
        run: |
          Compress-Archive -Path dist/* -DestinationPath EthoWild-windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EthoWild-windows-x64
          path: EthoWild-windows-x64.zip
          retention-days: 30

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: EthoWild-windows-x64.zip

  build-unix:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86-64
          - os: ubuntu-24.04
            triplet: x64-linux
            name: linux-x64

          # macOS ARM64 (Apple Silicon)
          - os: macos-14
            triplet: arm64-osx
            name: darwin-arm64

          # macOS x64 (Intel)
          - os: macos-13
            triplet: x64-osx
            name: darwin-x64

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Export GitHub Actions cache variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      # Install system dependencies (Linux)
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            build-essential \
            libatspi2.0-dev \
            libdbus-1-dev \
            libegl1-mesa-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libgl1-mesa-dev \
            libltdl-dev \
            libtool \
            libx11-xcb-dev \
            libxcb-cursor-dev \
            libxcb-icccm4-dev \
            libxcb-image0-dev \
            libxcb-keysyms1-dev \
            libxcb-randr0-dev \
            libxcb-render-util0-dev \
            libxcb-shape0-dev \
            libxcb-sync-dev \
            libxcb-util-dev \
            libxcb-xfixes0-dev \
            libxcb-xinerama0-dev \
            libxcb-xkb-dev \
            libxext-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxrender-dev \
            m4 \
            ninja-build \
            pkg-config

      # Install Ninja (macOS)
      - name: Install Ninja (macOS)
        if: runner.os == 'macOS'
        run: brew install ninja

      # Setup vcpkg
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "01f602195983451bc83e72f4214af2cbc495aa94"
          runVcpkgInstall: true
          vcpkgJsonGlob: "vcpkg.json"
        env:
          VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}

      - name: Configure CMake
        run: |
          cmake -B build -S . \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }}

      - name: Build
        run: cmake --build build --config Release

      - name: Package
        run: |
          mkdir -p dist
          cp build/EthoWild dist/
          cp behaviors.json dist/
          chmod +x dist/EthoWild

      - name: Create archive
        run: |
          cd dist
          zip -r ../EthoWild-${{ matrix.name }}.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EthoWild-${{ matrix.name }}
          path: EthoWild-${{ matrix.name }}.zip
          retention-days: 30

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: EthoWild-${{ matrix.name }}.zip
